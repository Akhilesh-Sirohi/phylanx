# Copyright (c) 2017 Hartmut Kaiser
#
# Distributed under the Boost Software License, Version 1.0. (See accompanying
# file LICENSE_1_0.txt or copy at http://www.boost.org/LICENSE_1_0.txt)

# partially taken from https://bloerg.net/2012/11/10/cmake-and-distutils.html

# build the extension module
add_subdirectory(src)

# integrate the extension module with the Python installation
find_program(PYTHON "python")

if (PYTHON)
  set(SETUP_PY_IN "${PROJECT_SOURCE_DIR}/cmake/templates/setup.py.in")
  set(DEPS "${CMAKE_CURRENT_SOURCE_DIR}/phylanx/__init__.py")

  set(SETUP_PY ${CMAKE_CURRENT_BINARY_DIR}/setup)
  set(OUTPUT "${CMAKE_CURRENT_BINARY_DIR}/build/timestamp")

  set(PYTHON_PACKAGE_BASE_DIR "${CMAKE_CURRENT_SOURCE_DIR}")
  set(PYTHON_BINARY_BASE_DIR "${CMAKE_BINARY_DIR}")
  if(WIN32)
    # the generated package base-dir needs to use '\\' instead of '/'
    string(REPLACE "/" "\\\\" PYTHON_PACKAGE_BASE_DIR ${PYTHON_PACKAGE_BASE_DIR})
    string(REPLACE "/" "\\\\" PYTHON_BINARY_BASE_DIR ${PYTHON_BINARY_BASE_DIR})
  endif()

  set(ADDITIONAL_COMMENT
    "Do not edit this file! It has been generated by the cmake configuration step.")

  set(__configs ${CMAKE_BUILD_TYPE})
  if(CMAKE_CONFIGURATION_TYPES)
    set(__configs ${CMAKE_CONFIGURATION_TYPES})
  endif()
  foreach (__config ${__configs})
    set(CONFIG ${__config})
    if(${__config} STREQUAL "Debug")
      set(PYTHON_PACKAGE_NAME "_phylanxd")
    else()
      set(PYTHON_PACKAGE_NAME "_phylanx")
    endif()
    configure_file(${SETUP_PY_IN} "${SETUP_PY}_${__config}.py" @ONLY)
  endforeach()

  set(__setup_script "${SETUP_PY}_$<CONFIG>.py")
  add_custom_command(OUTPUT ${OUTPUT}
                     COMMAND ${PYTHON} ${__setup_script} build
                     COMMAND ${CMAKE_COMMAND} -E touch ${OUTPUT}
                     DEPENDS ${DEPS})

  add_custom_target(Python ALL DEPENDS ${OUTPUT} ${__setup_script} phylanx_py)

  install(CODE "execute_process(COMMAND ${PYTHON} ${__setup_script} install)")
endif()
