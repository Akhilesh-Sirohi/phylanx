#  Copyright (c) 2017  R. Tohid
#
#  Distributed under the Boost Software License, Version 1.0. (See accompanying
#  file LICENSE_1_0.txt or copy at http://www.boost.org/LICENSE_1_0.txt)

machine:
    services:
        - docker
    environment:
        IMAGE_NAME: stellargroup/phylanx:dev

general:
    branches:
        ignore:
            - gh-pages

dependencies:
    pre:
        - docker build -t $IMAGE_NAME tools/docker:
            timeout: 1200
        - mkdir -p build

    override:
        - docker run -v $PWD:/phylanx -w /phylanx/build -e "CIRCLECI=true" ${IMAGE_NAME} cmake -DPHYLANX_WITH_GIT_COMMIT=${CIRCLE_SHA1} -DPHYLANX_WITH_TOOLS=On -DHPX_DIR=/usr/local/lib/cmake/HPX -Dpybind11_DIR=/pybind11/share/cmake/pybind11/ -Dblaze_DIR=/blaze/share/blaze/cmake -DCMAKE_BUILD_TYPE=Debug -DCMAKE_CXX_COMPILER=clang++ -DCMAKE_C_COMPILER=clang -DPHYLANX_WITH_HIGHFIVE=On -DHighFive_DIR=/highfive/share/HighFive/CMake ..
        - docker run -v $PWD:/phylanx -w /phylanx ${IMAGE_NAME} flake8 --filename=*.py,*.py.in --show-source --statistics --count .
        - docker run -v $PWD:/phylanx -w /phylanx/build ${IMAGE_NAME} make -j 2 -k tools.inspect
        - docker run -v $PWD:/phylanx -w /phylanx/build ${IMAGE_NAME} make -j 2

test:
    override:
        - docker run -v $PWD:/phylanx -w /phylanx/build ${IMAGE_NAME} make -j 2 tests
        - docker run -v $PWD:/phylanx -w /phylanx ${IMAGE_NAME} ./build/bin/inspect --all --output=./build/phylanx_inspect_report.html /phylanx
        - cp $PWD/build/phylanx_inspect_report.html ${CIRCLE_ARTIFACTS}/

deployment:
    hub:
        branch: master
        commands:
            - docker login -e ${DOCKER_EMAIL} -u ${DOCKER_USER} -p ${DOCKER_PASS}
            - docker push ${IMAGE_NAME}

